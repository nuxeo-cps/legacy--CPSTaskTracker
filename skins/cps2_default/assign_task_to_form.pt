<tal:block define="current_action string:view;
                   dummy python:request.set('breadcrumb_set',[])">
<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master">
  <metal:block fill-slot="base">
    <base href="." tal:attributes="href string:${here/absolute_url}/" />
  </metal:block>
<body>


<metal:block fill-slot="header">
   <h1 tal:content="here/title_or_id">
       Title
   </h1>
</metal:block>

<metal:block fill-slot="main">
  <p>
    <span tal:replace="python:mcat('_label_you_can_reassign_the_task_here')">
      You can re-assign this task here.
    </span>
  </p>
<form action="doChangeAssigned" method="post">
  <metal:block use-macro="here/main_widgets/macros/form">
    <metal:block fill-slot="content">

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_assigned_to_users')" />
        </metal:block>
        <metal:block fill-slot="content">
          <tal:block define="
            members here/members|nothing;
            text python:members and members[1] or '';
            dtool here/portal_metadirectories;
            directory dtool/members;
            allids python:[x['id_'] for x in directory.searchEntry()];
            old_ids python:(text not in ('',) and text.split('\r\n')) or [];
            ids python:[obj for obj in old_ids if obj in allids];
            new_text python:'\r\n'.join(ids);
            founds python:[directory.searchEntry(**{'id_': id}) for id in ids];">
            <tal:block define="
                       full_text_list python:[props[0][directory.display_prop] for props in founds];
                       full_text python:'\n'.join(full_text_list);
                       full_text_popup python:'$$'.join(full_text_list);
                       full_ids_list python:[props[0][directory.entry_prop] for props in founds];
                       full_ids python:'$$'.join(full_ids_list);
                       ">
              <textarea readonly
                        tal:attributes="name string:members;
                                        id string:members"
                        tal:content="full_text">
              </textarea>
              <input type="hidden" size="1"
                     tal:attributes="name string:members;id string:hidden_members;value new_text">

                <script language="JavaScript" type="text/javascript"><!--

                  function open_mb_selector(input_id) {
                    ids = document.getElementById('hidden_'+input_id).value.replace(/\n/g,'$$$$');
                    fulls = document.getElementById(input_id).value.replace(/\n/g,'$$$$');
                    //ids = ids.substring(0, ids.length-2);
                    //fulls = fulls.substring(0, fulls.length-2); // $$
                    args = 'input_id='+input_id+'&ids='+ids+'&fulls='+fulls;
                    selector_window = window.open('members_edit_form?'+args, 'members', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=475, height=420')

                    if(!selector_window.opener) selector_window.opener = window
                  }

                  function clean_textarea_user(input_id) {
                    c = document.getElementById(input_id);
                    c.value = '';
                    d = document.getElementById('hidden_'+input_id);
                    d.value = '';

                  }

                -->
                </script>
                <a tal:attributes="href string:javascript:open_mb_selector('members')">
                  <img border="0" src="img_box_edit.png" />
                </a>
            </tal:block>
          </tal:block>
         </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_assigned_to_groups')" />
        </metal:block>
        <metal:block fill-slot="content">
          <tal:block define="
            groups here/groups|nothing;
            text python:groups and groups[1] or '';
            dtool here/portal_metadirectories;
            directory dtool/groups;
            allids python:[x['id_'] for x in directory.searchEntry()];
            old_ids python:(text not in ('',) and text.split('\r\n')) or [];
            ids python:[obj for obj in old_ids if obj in allids];
            new_text python:'\r\n'.join(ids);
            founds python:[directory.searchEntry(**{'id_': id}) for id in ids];">
            <tal:block define="
                       full_text_list python:[props[0][directory.display_prop] for props in founds];
                       full_text python:'\n'.join(full_text_list);
                       full_text_popup python:'$$'.join(full_text_list);
                       full_ids_list python:[props[0][directory.entry_prop] for props in founds];
                       full_ids python:'$$'.join(full_ids_list);
                       ">
              <textarea readonly
                        tal:attributes="name string:groups;
                                        id string:groups"
                        tal:content="full_text">
              </textarea>
              <input type="hidden" size="1"
                     tal:attributes="name string:groups;id string:hidden_groups;value new_text">

                <script language="JavaScript" type="text/javascript"><!--

                  function open_gr_selector(input_id) {
                    ids = document.getElementById('hidden_'+input_id).value.replace(/\n/g,'$$$$');
                    fulls = document.getElementById(input_id).value.replace(/\n/g,'$$$$');
                    //ids = ids.substring(0, ids.length-2);
                    //fulls = fulls.substring(0, fulls.length-2); // $$
                    args = 'input_id='+input_id+'&ids='+ids+'&fulls='+fulls;
                    selector_window = window.open('groups_edit_form?'+args, 'groups', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=475, height=420')

                    if(!selector_window.opener) selector_window.opener = window
                  }

                  function clean_textarea_user(input_id) {
                    c = document.getElementById(input_id);
                    c.value = '';
                    d = document.getElementById('hidden_'+input_id);
                    d.value = '';

                  }

                -->
                </script>

                <a tal:attributes="href string:javascript:open_gr_selector('groups')">
                  <img border="0" src="img_box_edit.png" />
                </a>

            </tal:block>
          </tal:block>
       </metal:block>
      </metal:block>
  </metal:block>
 </metal:block>
   <input class="mainbutton" type="submit" name="submit" value="."
                tal:attributes="value python:mcat('_button_assign')" />
</form>
</metal:block>
</body>
</html>
</tal:block>
