<tal:block define="current_action string:edit;
                   create options/create|nothing;
                   dummy python:request.set('breadcrumb_set',[]);
                    ">
<html xmlns:tal="http://xml.zope.org/namespaces/tal" 
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master">
  <metal:block fill-slot="base">
    <base href="." tal:attributes="href string:${here/absolute_url}/">
  </metal:block>
<body>

<metal:block fill-slot="header">
  <tal:block condition="not:create">
    <tal:block replace="python:mcat('_Modify_(object name)_')">
      Modify
    </tal:block>
    «&nbsp;<span tal:replace="here/title_or_id">Title</span>&nbsp;»
  </tal:block>
</metal:block>

<metal:block fill-slot="header_plus" />

<metal:block fill-slot="main"
  tal:define="title python:(create and [''] or [here.Title()])[0];
                 description python:(create and [''] or [here.Description()])[0];
                 submitvalue python:create and mcat('_button_create_') or mcat('_button_modify_');
                 action python:create and 'cpsdocument_create' or 'cps_task_edit';
                 locked here/isDocumentLayoutLocked;
                 types_info here/get_compatible_task_block_types;
                 trans_types types_info/trans_types;
                 block_types types_info/block_types;
                 block_keys types_info/block_keys;
                 button_valid python:mcat('_button_validate_');
                 button_preview python:mcat('_button_preview_');
                 button_delete python:mcat('_button_delete_');
                 button_move_up python:mcat('_button_move_up_');
                 button_move_down python:mcat('_button_move_down_');
                 button_add python:mcat('_button_add_');
                 change_type_message python:mcat('_fd_Change_to_type_');
                 insert_message python:mcat('_fd_Insert_a_block_of_type_');
                ">

<!-- BEGINNING OF METADATA PART -->
  <form
      tal:omit-tag="locked"
      action="flexibledocument_task_edit" method="POST"
      enctype="multipart/form-data">

      <metal:block use-macro="here/main_widgets/macros/form">
        <metal:block fill-slot="content">
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_prop_title_')">
              Title
            </metal:block>
            <metal:block fill-slot="content">
              <input type="text" name="title" tal:attributes="value here/title" />
            </metal:block>
          </metal:block>
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_prop_description_')">
              Description
            </metal:block>
            <metal:block fill-slot="content">
              <textarea name="description:text" rows="5" cols="50" wrap="soft"
                tal:content="here/description"></textarea>
            </metal:block>
          </metal:block>
        </metal:block>
      </metal:block>
      <input class="mainbutton" type="submit"
        tal:condition="not:locked"
        tal:attributes="value button_valid" />
    </form>
<!-- END OF META DATA PART -->

<!-- BEGINNING OF SPECIFIC TASK PROPERTIES -->
  <form action="." method="post" enctype="multipart/form-data"
        tal:attributes="action action">

  <metal:block use-macro="here/main_widgets/macros/form">
    <metal:block fill-slot="content">

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_start_date')" />
        </metal:block>
        <metal:block fill-slot="content">
          <tal:block define="date here/get_date;
                             year date/year;
                             month date/month;
                             day date/day;
                            ">
            <script language="JavaScript" type="text/javascript"><!--
              function open_cal_selector(input_id, year, month) {
              selector_window = window.open('CalendarSelector_view?input_id='+input_id+'&month:int='+month+'&year:int='+year, 'calX_selector', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=150, height=180')
              if(!selector_window.opener) selector_window.opener = window
              }

              -->
            </script>
            <table border=0>
            <tr>
                <td>
                  <input type="text"
                         tal:define="current_task_start_date here/start_task_date|nothing;
                                     current_start_date python:here.get_date(str(current_task_start_date))"
                         tal:attributes="
                         name string:start_task_date;
                         id string:start_task_date;
                         size string:12;
                         value current_start_date/all" />
                  </td><td><a tal:attributes="href
                         string:javascript:open_cal_selector('start_task_date', '${year}','${month}')">
                       <img border="0" src="calendar.gif" /></a>
                </td>

              </tr></table>
          </tal:block>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_stop_date')" />
        </metal:block>
        <metal:block fill-slot="content">
                  <tal:block define="date here/get_date;
                             year date/year;
                             month date/month;
                             day date/day;
                            ">
            <script language="JavaScript" type="text/javascript"><!--
              function open_cal_selector(input_id, year, month) {
              selector_window = window.open('CalendarSelector_view?input_id='+input_id+'&month:int='+month+'&year:int='+year, 'calX_selector', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=150, height=180')
              if(!selector_windowopener) selector_window.opener = window
              }

              -->
            </script>
            <table border=0>
            <tr>
                <td>
                  <input type="text"
                         tal:define="current_task_stop_date here/stop_task_date|nothing;
                                     current_stop_date python:here.get_date(str(current_task_stop_date))"
                         tal:attributes="
                         name string:stop_task_date;
                         id string:stop_task_date;
                         size string:12;
                         value current_stop_date/all" />
                  </td><td><a tal:attributes="href
                         string:javascript:open_cal_selector('stop_task_date', '${year}','${month}')">
                       <img border="0" src="calendar.gif" /></a>
                </td>

              </tr></table>
          </tal:block>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_priority')" />
        </metal:block>
        <metal:block fill-slot="content">
          <select name="task_priority"
                  tal:define="the_priority here/task_priority|nothing">

            <option value="high" tal:content="string:high"
                    tal:condition="python:the_priority !='high'">high</option>
            <option value="high" tal:content="string:high" selected
                    tal:condition="python:the_priority=='high'">high</option>

            <option value="normal" tal:content="string:normal"
                    tal:condition="python:the_priority !='normal'">normal</option>
            <option value="normal" tal:content="string:normal" selected
                    tal:condition="python:the_priority =='normal'">normal</option>

            <option value="low" tal:content="string:low"
                    tal:condition="python:the_priority !='low'">low</option>
            <option value="low" tal:content="string:low" selected
                    tal:condition="python:the_priority =='low'">low</option>
          </select>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_indicator')" />
        </metal:block>
        <metal:block fill-slot="content">
          <select name="task_indicator"
                  tal:define="the_indicator here/task_indicator|nothing">

            <option value="normal" tal:content="string:normal"
                    tal:condition="python:the_indicator != 'normal'">normal</option>
            <option value="normal" tal:content="string:normal" selected
                    tal:condition="python:the_indicator == 'normal'">normal</option>

            <option value="critical" tal:content="string:critical"
                    tal:condition="python:the_indicator !='critical'">critical</option>
            <option value="critical" tal:content="string:critical" selected
                    tal:condition="python:the_indicator == 'critical'">critical</option>

            <option value="late" tal:content="string:late"
                    tal:condition="python:the_indicator != 'late'">late</option>
            <option value="late" tal:content="string:late" selected
                    tal:condition="python:the_indicator == 'late'">late</option>

          </select>
        </metal:block>
       </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_type')" />
         </metal:block>
        <metal:block fill-slot="content">
          <select name="task_type"
                  tal:define="the_type here/task_type|nothing">
            <tal:block repeat="type python:here.getTaskTypes()">
              <option value="."
                      tal:condition="python:the_type != type"
                      tal:attributes="value type"
                      tal:content="type">
                Task Type
              </option>
              <option value="." selected
                      tal:condition="python:the_type == type"
                      tal:attributes="value type"
                      tal:content="type">
                Task Type
              </option>
            </tal:block>
          </select>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_assigned_to_users')" />
        </metal:block>
        <metal:block fill-slot="content">
          <tal:block define="
            members here/members|nothing;
            text python:members and members[1] or '';
            dtool here/portal_metadirectories;
            directory dtool/members;
            allids python:[x['id_'] for x in directory.searchEntry()];
            old_ids python:(text not in ('',) and text.split('\r\n')) or [];
            ids python:[obj for obj in old_ids if obj in allids];
            new_text python:'\r\n'.join(ids);
            founds python:[directory.searchEntry(**{'id_': id}) for id in ids];">
            <tal:block define="
                       full_text_list python:[props[0][directory.display_prop] for props in founds];
                       full_text python:'\n'.join(full_text_list);
                       full_text_popup python:'$$'.join(full_text_list);
                       full_ids_list python:[props[0][directory.entry_prop] for props in founds];
                       full_ids python:'$$'.join(full_ids_list);
                       ">
              <textarea readonly
                        tal:attributes="name string:members;
                                        id string:members"
                        tal:content="full_text">
              </textarea>
              <input type="hidden" size="1"
                     tal:attributes="name string:members;id string:hidden_members;value new_text">

                <script language="JavaScript" type="text/javascript"><!--

                  function open_mb_selector(input_id) {
                    ids = document.getElementById('hidden_'+input_id).value.replace(/\n/g,'$$$$');
                    fulls = document.getElementById(input_id).value.replace(/\n/g,'$$$$');
                    //ids = ids.substring(0, ids.length-2);
                    //fulls = fulls.substring(0, fulls.length-2); // $$
                    args = 'input_id='+input_id+'&ids='+ids+'&fulls='+fulls;
                    selector_window = window.open('members_edit_form?'+args, 'members', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=450, height=420')

                    if(!selector_window.opener) selector_window.opener = window
                  }

                  function clean_textarea_user(input_id) {
                    c = document.getElementById(input_id);
                    c.value = '';
                    d = document.getElementById('hidden_'+input_id);
                    d.value = '';

                  }

                -->
                </script>

                <a tal:attributes="href string:javascript:open_mb_selector('members')">
                  <img border="0" src="img_box_edit.png" />
                </a>

            </tal:block>
          </tal:block>
         </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_assigned_to_groups')" />
        </metal:block>
        <metal:block fill-slot="content">
          <tal:block define="
            groups here/groups|nothing;
            text python:groups and groups[1] or '';
            dtool here/portal_metadirectories;
            directory dtool/groups;
            allids python:[x['id_'] for x in directory.searchEntry()];
            old_ids python:(text not in ('',) and text.split('\r\n')) or [];
            ids python:[obj for obj in old_ids if obj in allids];
            new_text python:'\r\n'.join(ids);
            founds python:[directory.searchEntry(**{'id_': id}) for id in ids];">
            <tal:block define="
                       full_text_list python:[props[0][directory.display_prop] for props in founds];
                       full_text python:'\n'.join(full_text_list);
                       full_text_popup python:'$$'.join(full_text_list);
                       full_ids_list python:[props[0][directory.entry_prop] for props in founds];
                       full_ids python:'$$'.join(full_ids_list);
                       ">
              <textarea readonly
                        tal:attributes="name string:groups;
                                        id string:groups"
                        tal:content="full_text">
              </textarea>
              <input type="hidden" size="1"
                     tal:attributes="name string:groups;id string:hidden_groups;value new_text">

                <script language="JavaScript" type="text/javascript"><!--

                  function open_gr_selector(input_id) {
                    ids = document.getElementById('hidden_'+input_id).value.replace(/\n/g,'$$$$');
                    fulls = document.getElementById(input_id).value.replace(/\n/g,'$$$$');
                    //ids = ids.substring(0, ids.length-2);
                    //fulls = fulls.substring(0, fulls.length-2); // $$
                    args = 'input_id='+input_id+'&ids='+ids+'&fulls='+fulls;
                    selector_window = window.open('groups_edit_form?'+args, 'groups', 'toolbar=0, scrollbars=0, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=450, height=420')

                    if(!selector_window.opener) selector_window.opener = window
                  }

                  function clean_textarea_user(input_id) {
                    c = document.getElementById(input_id);
                    c.value = '';
                    d = document.getElementById('hidden_'+input_id);
                    d.value = '';

                  }

                -->
                </script>

                <a tal:attributes="href string:javascript:open_gr_selector('groups')">
                  <img border="0" src="img_box_edit.png" />
                </a>

            </tal:block>
          </tal:block>
       </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_project')" />
        </metal:block>
        <metal:block fill-slot="content">
          <input name="task_project" value=""
                 tal:attributes="value here/task_project|nothing" />
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/form_property">
        <metal:block fill-slot="title">
          <span tal:replace="python:mcat('_label_goal')" />
        </metal:block>
        <metal:block fill-slot="content">
          <textarea name="task_goal:text" rows="5" cols="50" wrap="soft"
                    tal:content="here/task_goal|nothing"></textarea>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/main_widgets/macros/linkswidget">
          Related links
      </metal:block>
   </metal:block>
 </metal:block>



  <input type="hidden" name="type_name" value="CPS Task">
  <tal:block condition="create">
    <input type="hidden" name="default_id_from" value="title" />
    <input type="hidden" name="default_title_from" value="description" />
  </tal:block>
  <input class="mainbutton" type="submit" value="." tal:attributes="value submitvalue">
  <input class="mainbutton" type="button" name="cancel" onclick="history.back()"
    tal:attributes="value python:mcat('_button_cancel_')">

  </form>
<!-- END OF SPECIFIC TASK PROPERTIES -->

<!-- FLEXIBLE PART OF THE DOCUMENT -->
<form
    tal:omit-tag="not:locked"
    action="flexibledocument_task_edit" method="POST" enctype="multipart/form-data">
<hr>
    <tal:block
      define="blocks python:here.getRenderedBlocks(render_type='form')">
      <tal:block repeat="block blocks">
        <tal:block define="
          block_id block/block_id;
          block_type block/block_type;
          can_modify python:block_types[block_type]['slots']">
          <a tal:attributes="name block_id"></a>
          <form tal:condition="not:locked"
            action="flexibledocument_task_addblock" method="GET">
            <input type="hidden" name="before_block"
              tal:attributes="value block_id">
            <tal:block
              replace="insert_message">
              Insert a block of type
            </tal:block>
            <select name="block_type">
              <tal:block repeat="block_key block_keys">
                <option
                  tal:attributes="value block_key"
                  tal:condition="python:not block_types[block_key].get('invisible')"
                  tal:content="python:mcat(block_types[block_key]['title'])" />
              </tal:block>
            </select>
            <input class="mainbutton" type="submit"
              tal:attributes="value button_add">
          </form>
          <form
            tal:omit-tag="locked"
            action="flexibledocument_task_edit" method="POST"
            enctype="multipart/form-data"
	    tal:attributes="name block/block_id">
            <table bgcolor="#DDDDDD" cellspacing="0" cellpadding="0" width="100%" border="0">
              <tr>
                <td>
                  <tal:block replace="structure block/content" />
                </td>
              </tr>
              <tr tal:condition="not:locked">
                <td>
                  <input type="button" class="mainbutton"
                    tal:condition="can_modify"
                    tal:attributes="
                    onClick string:window.open('${here/absolute_url}/flexibledocument_block_preview?block_id=${block_id}', 'block_preview', 'toolbar=0');
                    value button_preview;
                    " />
                  <input class="mainbutton" type="submit"
                    tal:condition="not:repeat/block/start"
                    tal:attributes="
                      name string:move_up_${block_id};
                      value button_move_up">
                  <input class="mainbutton" type="submit"
                    tal:condition="not:repeat/block/end"
                    tal:attributes="
                      name string:move_down_${block_id};
                      value button_move_down">
                  <input class="mainbutton" type="submit"
                    tal:attributes="
                      name string:delete_${block_id};
                      value button_delete;
                    ">
                  <tal:block
                    define="trans_type trans_types/?block_type"
                    condition="python:(not locked) and len(trans_type)>1">
                    <br />
                    <tal:block replace="change_type_message">
                      Change to type:
                    </tal:block>
                    <select
                      tal:attributes="
                        name string:change_type_${block_id}">
                      <option
                        tal:repeat="type trans_type"
                        tal:attributes="
                          value type/id;
                          selected python:type['id'] == block_type"
                        tal:content="type/title" />
                    </select>
                  </tal:block>
                  <tal:block condition="can_modify">
                    <br />
                    <input class="mainbutton" type="submit"
                      tal:attributes="value button_valid" />
                  </tal:block>
                </td>
              </tr>
            </table>
          </form>
        </tal:block>
      </tal:block>
    </tal:block>
    <input class="mainbutton" type="submit"
      tal:condition="locked"
      tal:attributes="value button_valid" />
 </form>

<!-- END OF FLEXIBLE PART -->
<!-- To add files -->
<tal:block define="locked here/isDocumentLayoutLocked;
                   types_info here/get_compatible_task_block_types;
                   block_keys types_info/block_keys;
                   block_types types_info/block_types;
                   button_add python:mcat('_button_add_')
                   ">
  <form action="flexibledocument_task_addblock"
    tal:condition="not:locked">
    <tal:block replace="python:mcat('_fd_Add_a_new_block_of_type_')">
      Add a new block of type
    </tal:block>
    <select name="block_type">
      <tal:block repeat="block_key block_keys">
        <option
          tal:attributes="value block_key"
          tal:condition="python:not block_types[block_key].get('invisible')"
          tal:content="python:mcat(block_types[block_key]['title'])" />
      </tal:block>
    </select>
    <input class="mainbutton" type="submit"
      tal:attributes="value button_add">
  </form>
</tal:block>

</metal:block>


</body>
</html>
</tal:block>
